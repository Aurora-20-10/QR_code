<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <title>Tr·∫°m QR c·ªßa Aurora</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      background-color: #111;
      color: #fff;
      margin: 0;
      padding: 20px;
    }
    h1 {
      text-align: center;
      color: #00f5d4;
    }
    .group {
      margin-bottom: 40px;
      border: 1px solid #444;
      padding: 20px;
      border-radius: 8px;
    }
    .qr-item {
      background-color: #222;
      border: 1px solid #333;
      margin: 10px 0;
      padding: 10px;
      border-radius: 6px;
    }
    .qr-img {
      margin-top: 10px;
    }
    input, select, button {
      padding: 8px;
      margin: 4px;
      background-color: #333;
      color: #fff;
      border: 1px solid #666;
      border-radius: 4px;
    }
    button:hover {
      background-color: #444;
    }
    textarea {
      background-color: #333;
      color: #fff;
      border: 1px solid #666;
      border-radius: 4px;
      padding: 6px;
      width: 100%;
      margin-top: 6px;
    }
  </style>
</head>
<body>
  <h1>Tr·∫°m QR c·ªßa Aurora</h1>

  <div>
    <input id="content" placeholder="N·ªôi dung m√£ QR">
    <input id="note" placeholder="Ghi ch√∫">
    <input id="tag" placeholder="Ph√¢n lo·∫°i (C√¥ng vi·ªác, C√° nh√¢n, ...)">
    <button onclick="addQR()">T·∫°o m√£</button>
    <button onclick="exportData()">Xu·∫•t to√†n b·ªô</button>
    <input type="file" onchange="importData(event)">
  </div>

  <div>
    <label>L·ªçc theo ph√¢n lo·∫°i:</label>
    <select id="filter-tag" onchange="renderQRs()">
      <option value="">-- T·∫•t c·∫£ --</option>
    </select>

    <label>L·ªçc theo th√°ng:</label>
    <select id="filter-month" onchange="renderQRs()">
      <option value="">-- T·∫•t c·∫£ --</option>
    </select>
  </div>

  <div id="qr-groups"></div>

  <script src="https://cdn.jsdelivr.net/npm/qrcode/build/qrcode.min.js"></script>
  <script>
    let qrData = JSON.parse(localStorage.getItem('aurora_qr_list') || '[]');

    function saveData() {
      localStorage.setItem('aurora_qr_list', JSON.stringify(qrData));
      renderQRs();
    }

    function addQR() {
      const content = document.getElementById('content').value.trim();
      const note = document.getElementById('note').value.trim();
      const tag = document.getElementById('tag').value.trim() || 'Ch∆∞a ph√¢n lo·∫°i';
      if (!content) return alert('N·ªôi dung kh√¥ng ƒë∆∞·ª£c ƒë·ªÉ tr·ªëng');

      qrData.push({ content, note, tag, time: new Date().toISOString() });
      saveData();

      document.getElementById('content').value = '';
      document.getElementById('note').value = '';
      document.getElementById('tag').value = '';
    }

    function renderQRs() {
      const filterTag = document.getElementById('filter-tag').value;
      const filterMonth = document.getElementById('filter-month').value;

      const filteredData = qrData.filter(qr => {
        const matchTag = !filterTag || qr.tag === filterTag;
        const matchMonth = !filterMonth || qr.time.slice(0, 7) === filterMonth;
        return matchTag && matchMonth;
      });

      const grouped = {};
      filteredData.forEach(qr => {
        if (!grouped[qr.tag]) grouped[qr.tag] = [];
        grouped[qr.tag].push(qr);
      });

      const qrGroups = document.getElementById('qr-groups');
      qrGroups.innerHTML = '';
      for (let tag in grouped) {
        const groupDiv = document.createElement('div');
        groupDiv.className = 'group';
        const title = document.createElement('h2');
        title.textContent = `üìÇ ${tag}`;
        groupDiv.appendChild(title);

        grouped[tag].forEach((qr, idx) => {
          const item = document.createElement('div');
          item.className = 'qr-item';

          const info = document.createElement('div');
          info.innerHTML = `<b>Ng√†y:</b> ${new Date(qr.time).toLocaleString()}`;

          const noteInput = document.createElement('textarea');
          noteInput.value = qr.note || '';
          noteInput.placeholder = "Ghi ch√∫";
          noteInput.onchange = () => {
            qr.note = noteInput.value;
            saveData();
          };

          const tagInput = document.createElement('input');
          tagInput.value = qr.tag;
          tagInput.placeholder = "Ph√¢n lo·∫°i";
          tagInput.onchange = () => {
            qr.tag = tagInput.value || 'Ch∆∞a ph√¢n lo·∫°i';
            saveData();
          };

          const canvas = document.createElement('canvas');
          canvas.className = 'qr-img';
          QRCode.toCanvas(canvas, qr.content, { width: 120 });

          const delBtn = document.createElement('button');
          delBtn.textContent = '‚ùå Xo√°';
          delBtn.onclick = () => {
            qrData = qrData.filter(q => !(q.content === qr.content && q.time === qr.time));
            saveData();
          };

          const downloadBtn = document.createElement('button');
          downloadBtn.textContent = '‚¨áÔ∏è T·∫£i';
          downloadBtn.onclick = () => {
            const link = document.createElement('a');
            link.download = `QR.png`;
            link.href = canvas.toDataURL();
            link.click();
          };

          item.appendChild(info);
          item.appendChild(noteInput);
          item.appendChild(tagInput);
          item.appendChild(canvas);
          item.appendChild(downloadBtn);
          item.appendChild(delBtn);
          groupDiv.appendChild(item);
        });

        qrGroups.appendChild(groupDiv);
      }

      updateFilters();
    }

    function updateFilters() {
      const tagSet = new Set();
      const monthSet = new Set();

      qrData.forEach(qr => {
        tagSet.add(qr.tag);
        monthSet.add(qr.time.slice(0, 7));
      });

      const tagSelect = document.getElementById('filter-tag');
      const monthSelect = document.getElementById('filter-month');

      const currentTag = tagSelect.value;
      const currentMonth = monthSelect.value;

      tagSelect.innerHTML = '<option value="">-- T·∫•t c·∫£ --</option>';
      Array.from(tagSet).sort().forEach(tag => {
        const option = document.createElement('option');
        option.value = tag;
        option.textContent = tag;
        if (tag === currentTag) option.selected = true;
        tagSelect.appendChild(option);
      });

      monthSelect.innerHTML = '<option value="">-- T·∫•t c·∫£ --</option>';
      Array.from(monthSet).sort().forEach(month => {
        const option = document.createElement('option');
        option.value = month;
        option.textContent = month;
        if (month === currentMonth) option.selected = true;
        monthSelect.appendChild(option);
      });
    }

    function exportData() {
      const blob = new Blob([JSON.stringify(qrData)], { type: 'application/json' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = 'aurora_qr_data.json';
      a.click();
    }

    function importData(event) {
      const file = event.target.files[0];
      if (!file) return;
      const reader = new FileReader();
      reader.onload = e => {
        try {
          const imported = JSON.parse(e.target.result);
          if (!Array.isArray(imported)) throw new Error();
          qrData = imported;
          saveData();
        } catch {
          alert('T·∫≠p tin kh√¥ng h·ª£p l·ªá');
        }
      };
      reader.readAsText(file);
    }

    renderQRs();
  </script>
</body>
</html>
